#!/bin/sh

set -eu

. ./lib/file-format.sh

main() {
	command -v git >/dev/null 2>&1 \
		|| die "Git must be installed to use this program."

	[ $# -ge 1 ] || usage

	[ -d "${SN_DATA:=$HOME/.sn}" ] || mkdir -p "${SN_DATA}" \
		|| die "Creating sn data directory"

	network=
	while getopts n: option ; do
		case $option in
			n) network="$OPTARG" ;;
			?) usage ;;
		esac
	done
	shift $((OPTIND - 1))

	[ $# -ge 1 ] || usage

	cmd=$1
	shift

	trap clean EXIT INT

	case $cmd in
		create)
			[ -n "$network" ] || die "Network option must be provided" true
			cmd_create "$network"
		;;

		post)
			cmd_post "$network" "$@"
		;;

		--help|-h)
			usage
		;;

		*)
			die "Invalid command"
		;;
	esac
}

usage() {
	cat <<EOF
Usage: ${0##*/} [-n network-name] <command>
EOF
	exit 1
}

die() {
	echo "Error: $1" >&2
	[ -n "${2:-}" ] && usage
	exit 1
}

clean() {
	[ -e "${tmpfile:-}" ] && rm -f "$tmpfile" >/dev/null 2>&1
}

config_file() {
	echo "${SN_DATA}/config"
}

posts_file() {
	echo post
}

network_dir() {
	echo "${SN_DATA}/$1"
}

get_config() {
	network=$1
	variable=$2
	awk -F= "/^${network}_${variable}/ { print \$2 }" "$(config_file)"
}

get_default_network() {
	# we don't use -maxdepth because it's not POSIX standard
	networks=$(find "$SN_DATA" -type d ! -path '*.git*' \
									-a ! -path "$SN_DATA"\
									-a ! -path "$SN_DATA/*/*")
	if [ "$(echo "$networks" | wc -l)" = "1" ]; then
		echo "${networks##*/}"
	else
		default_network=$(get_config default network)
		[ -n "$default_network" ] || die "No default network defined in config"
		echo "$default_network"
	fi
}

get_editor() {
	for editor in "${VISUAL:-}" "${EDITOR:-}" ; do
		if command -v "$editor" >/dev/null 2>&1 ; then
			echo "$editor"
			return
		fi
	done
	echo "vi"
}

# pre: working directory is a valid network with a git repository
add_user() {
	user=$1
	mkdir "$user" || die "Creating user directory"
	create_file "$user/$(posts_file)"
	git add "$user" >/dev/null
	git commit -m "User '$user' joined" >/dev/null
	echo "${network}_username=$USER" >> "$(config_file)"
}

# pre: working directory is a valid network with a git repository
add_message() {
	username=$1
	file=$2
	shift 2
	append_file "$username/$file" "$@"
	git add "$username" >/dev/null
	git commit -m "User '$username' added $file" >/dev/null
}

cmd_create() {
	network=$1
	mkdir -p "$(network_dir "$network")" || die "Creating network directory"
	cd "$(network_dir "$network")" \
		|| die "Unable to change into network directory"
	git init > /dev/null
	add_user "$USER"
	echo "Created network '$network'. Joined as '$USER'."
}

cmd_post() {
	network=${1:-$(get_default_network)}
	shift
	cd "$(network_dir "$network")" \
		|| die "Unable to change into network directory"
	username=$(get_config "$network" username)
	[ -n "$username" ] \
		|| die "Invalid username for network '$network' in '$(config_file)'"
	message="$*"
	if [ -z "$message" ]; then
		umask 077
		tmpfile=$(mktemp)
		[ -n "$tmpfile" ] && $(get_editor) "$tmpfile"
		message=$(cat "$tmpfile")
		rm -f "$tmpfile"
	fi
	[ -n "$message" ] || die "Can't post empty message"
	add_message "$username" "$(posts_file)" "$message"
	echo "Posted message to '$network' with user '$username'"
}

main "$@"
