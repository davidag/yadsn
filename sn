#!/bin/sh

set -eu


main() {
	[ $# -ge 1 ] || usage

	[ -d "${SN_DATA:=$HOME/.sn}" ] || mkdir -p "${SN_DATA}" \
		|| die "Creating sn data directory"

	network=
	while getopts n: option ; do
		case $option in
			n) network="$OPTARG" ;;
			?) usage ;;
		esac
	done
	shift $((OPTIND - 1))

	[ $# -ge 1 ] || usage

	cmd=$1
	shift

	trap clean EXIT INT

	case $cmd in
		create)
			[ -n "$network" ] || die "Network option must be provided" true
			cmd_create "$network"
		;;

		post)
			cmd_post "$network" "$@"
		;;

		--help|-h)
			usage
		;;

		*)
			die "Invalid command"
		;;
	esac
}

usage() {
	cat <<EOF
Usage: ${0##*/} [-n network-name] <command>"
EOF
	exit 1
}

die() {
	echo "Error: $1" >&2
	[ -n "${2:-}" ] && usage
	exit 1
}

clean() {
	[ -e "${tmpfile:-}" ] && rm -f "$tmpfile" >/dev/null 2>&1
}

config_file() {
	echo "${SN_DATA}/config"
}

get_config() {
	network=$1
	variable=$2
	awk -F= "/^${network}_${variable}/ { print \$2 }" "$(config_file)"
}

get_default_network() {
	networks=$(find "$SN_DATA" -type d ! -path '*.git*' -a ! -path "$SN_DATA")
	if [ "$(echo "$networks" | wc -l)" = "1" ]; then
		echo "${networks##*/}"
	else
		default_network=$(get_config default network)
		[ -n "$default_network" ] || die "No default network defined in config"
		echo "$default_network"
	fi
}

get_editor() {
	for editor in "${VISUAL:-}" "${EDITOR:-}" ; do
		if command -v "$editor" >/dev/null 2>&1 ; then
			echo "$editor"
			return
		fi
	done
	echo "vi"
}

cmd_create() {
	network=$1
	dir=${SN_DATA}/$network
	mkdir -p "$dir" || die "Creating network directory"
	cd "$dir" || die "Unable to change into network directory"
	git init > /dev/null
	echo "${network}_username=$USER" >> "$(config_file)"
	echo "Created network '$network'. Joined as '$USER'."
}

cmd_post() {
	network=${1:-$(get_default_network)}
	shift
	cd "$SN_DATA/$network" || die "Unable to change into network directory"
	username=$(get_config "$network" username)
	[ -n "$username" ] \
		|| die "Invalid username for network '$network' in '$(config_file)'"
	message="$*"
	if [ -z "$message" ]; then
		umask 077
		tmpfile=$(mktemp)
		[ -n "$tmpfile" ] && $(get_editor) "$tmpfile"
		message=$(cat "$tmpfile")
		rm -f "$tmpfile"
	fi
	[ -z "$message" ] && die "Can't post empty message"
	echo "$message" | sed "1s/.*/[$(date -Is)]&/" >> "$username"
	git add "$username" >/dev/null
	git commit -m "$username:post:$(echo "$message" | sed -n '1p')" >/dev/null
	echo "Posted message to '$network' with user '$username'"
}

main "$@"
